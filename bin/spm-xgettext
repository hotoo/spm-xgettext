#!/usr/bin/env node

var path = require('path');
var commander = require('commander');
var color = require('colorful').color;
var fs = require('fs');
var xgettext = require('..');
var pkg = require('../package.json');
var spmrc = require("spmrc");
var mkdirp = require("mkdirp");

var src = "src/";

//var DEFAULT_LOCALE_PATH = 'locale/{locale}/LC_MESSAGES/{name}.js';
var DEFAULT_LOCALE_PATH = 'locale/{locale}/LC_MESSAGES';

// commander gettext
commander
  .version(pkg.version)
  .usage('[locale]')
  .option('-v, --verbose', 'Show more infomation.')
  .option('-f, --force', 'Force to process the task.');

commander.on('--help', function() {
  console.log();
  console.log('  Change locale directory in ~/.spm/spmrc');
  console.log();
  console.log(color.magenta('    [gettext]'));
  console.log('    path = ./locale/{locale}/LC_MESSAGES.js');
  console.log();
});
commander.parse(process.argv);



var src_file = "./src/" + pkg.name + ".js";

if(fs.existsSync(src_file)){

  fs.readFile(src_file, {encoding:"utf-8"}, function(err, data){

    var locale = xgettext(data);
    var path = commander["locale-path"] ||
               spmrc.get('xgettext.locale_path') ||
               DEFAULT_LOCALE_PATH;
    var locale_names = commander.args || locale.names || [];

    for(var i=0,l=locale_names.length; i<l; i++){
      mkdirp(src + path.replace(/\{locale(?:\:[^\}]*)?\}/g, locale_names[i]), function(err){
        if(!err){

          // TODO: write locale content.

        }else{
          console.error(err);
        }
      });
    }

  });

}else{
  console.error("Not found file " + src_file);
}

// vim:ft=javascript
